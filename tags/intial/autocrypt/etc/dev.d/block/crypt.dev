#!/bin/bash
#/***********************************************************************
#* copyright (c) 2004 MALET Jean-luc aka cityhunter
#* This program is free software; you can redistribute it and/or modify
#* it under the terms of the artistic license as published in the top source dir of the
#* package
#************************************************************************/
MOUNT_BASE="/tmp/removable"
PWD=/
OLDPWD=/
echo $DEVPATH



if [ "$ACTION" == "add" ]; then 
	if [ -d /sys/$DEVPATH/../ ] && 
		 [ -f /sys/$DEVPATH/../removable ] &&
 		 [ "1" == "$(cat /sys/$DEVPATH/../removable)" ]; then
		for DISK in  $(echo $DEVPATH |sed "s:^.*/::")
		do
			mkdir -p $MOUNT_BASE-$DISK
			mount $DEVNAME $MOUNT_BASE-$DISK -o defaults,sync,dirsync,noatime
			if [ -x $MOUNT_BASE-$DISK/cryptsetup ] &&
					! test -f /tmp/cryptkey; 
			then
					#echo "running $MOUNT_BASE-$DISK/cryptsetup" > /dev/tty9
					cd $MOUNT_BASE-$DISK/
					$MOUNT_BASE-$DISK/cryptsetup
					echo $DEVNAME > /tmp/cryptkey
					chmod go-rwx /tmp/cryptkey
			fi
			cd /
			while ! umount $MOUNT_BASE-$DISK ; do
				sleep 3s
			done
			rm -rf $MOUNT_BASE-$DISK
		done
	fi
else
	if [ "$DEVNAME" == "$(cat /tmp/cryptkey)" ]; then 
		for DISK in $(cat /tmp/cryptdevs ); do
			while grep -q $DISK /etc/mtab; do
				sleep 1m
			done
			cryptsetup remove $DISK
		done
		rm /tmp/cryptkey
		rm /tmp/cryptdevs
	fi
fi

